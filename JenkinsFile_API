pipeline {
    agent {
        docker {
            image 'python:latest'
            label 'my-build-agent'
        }
	}
    stages {
        stage('Test') {
            steps {
                // Get some code from a GitHub repository
                git branch: 'master', url: 'https://github.com/veracode/veracode-python-hmac-example.git'
            }
        }
        //withCredentials uses credentials plugin with credentials stored in configuration
		stage('Python Stage') {
			steps {
				withCredentials([ usernamePassword (credentialsId: 'veracode_login', usernameVariable: 'VERACODE_API_ID', passwordVariable: 'VERACODE_API_KEY') ]) {
					script { 
						try {
						sh """
						python --version
						python ./example.py
						"""
						} catch (err) { 
							echo 'Error code: ' + err.getMessage().substring(26)
						}
					echo 'end of test'
					}
				}
			}
		}
	}
}
