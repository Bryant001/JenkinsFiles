pipeline {
    agent any
    stages {
        //withCredentials uses credentials plugin with credentials stored in configuration
		stage('DAST Essentials') {
			steps {
				withCredentials([ usernamePassword (credentialsId: 'veracode_login', usernameVariable: 'VERACODE_API_KEY_ID', passwordVariable: 'VERACODE_API_KEY_SECRET') ]) {
					script { 
					    echo 'Set variables for findings report'
					    	WEBHOOK='8297440b-3dae-4e35-a83c-5311b97f97aa'
						echo \$WEBHOOK
						API_ID='$VERACODE_API_KEY_ID'
						API_SECRET='$VERACODE_API_KEY_SECRET'
						//Set the API endpoint
						//Use “api.veracode.com” for US instance or “api.veracode.eu” for EU instance
						API_ENDPOINT='api.veracode.com'
						API_PATH='/dae/api/core-api/webhook'
						try {
						    sh """#!/bin/bash
							echo "Stop the script as soon as the first command fails"
							set -euo pipefail

							
							echo "Start Security Scan"
							echo "Start Scan and get scan ID"
							signing_data="id=${API_ID}&host=${API_ENDPOINT}&url=${API_PATH}/${WEBHOOK}&method=POST"
							"""
						} catch (err) { 
							echo 'Error code: ' + err.getMessage().substring(26)
						}
					echo "end of test"
					}
				}
			}
		}
	}
}
